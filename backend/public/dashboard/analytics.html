<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - Renovation Vision</title>
    <link rel="stylesheet" href="dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2>üè† Renovation Vision</h2>
            </div>
            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    üìä Dashboard
                </a>
                <a href="leads.html" class="nav-item">
                    üë• Leads
                </a>
                <a href="analytics.html" class="nav-item active">
                    üìà Analytics
                </a>
                <a href="#" class="nav-item">
                    ‚öôÔ∏è Settings
                </a>
            </nav>
            <div class="sidebar-footer">
                <p><strong id="companyName">Loading...</strong></p>
                <p class="text-small">Trial ‚Ä¢ 14 days left</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1>Analytics</h1>
                <select id="periodFilter" class="filter-select">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                    <option value="365">Last Year</option>
                </select>
            </header>

            <!-- Charts -->
            <div class="section">
                <h2>Leads Over Time</h2>
                <canvas id="leadsChart" height="80"></canvas>
            </div>

            <div class="section">
                <h2>Conversion Funnel</h2>
                <canvas id="funnelChart" height="80"></canvas>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                <div class="section">
                    <h2>Lead Status Distribution</h2>
                    <canvas id="statusChart"></canvas>
                </div>

                <div class="section">
                    <h2>Budget Breakdown</h2>
                    <canvas id="budgetChart"></canvas>
                </div>
            </div>

            <div class="section">
                <h2>Revenue Tracking</h2>
                <canvas id="revenueChart" height="80"></canvas>
            </div>
        </main>
    </div>

    <script src="dashboard.js"></script>
    <script>
        // Check if logged in
        const companyId = sessionStorage.getItem('companyId');
        if (!companyId) {
            window.location.href = 'login.html';
        }
        window.COMPANY_ID = companyId;

        // Update company name
        const companyName = sessionStorage.getItem('companyName');
        if (companyName) {
            document.getElementById('companyName').textContent = companyName;
        }
        window.API_URL = 'https://renovation-ai-production.up.railway.app';

        async function loadAnalytics() {
            try {
                const response = await fetch(`${window.API_URL}/api/company/${window.COMPANY_ID}/leads`);
                const data = await response.json();

                if (data.success) {
                    createCharts(data.leads);
                }
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }

        function createCharts(leads) {
            // Leads Over Time Chart
            const leadsCtx = document.getElementById('leadsChart').getContext('2d');
            new Chart(leadsCtx, {
                type: 'line',
                data: {
                    labels: getLast30Days(),
                    datasets: [{
                        label: 'Leads',
                        data: getLeadsByDay(leads),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });

            // Status Distribution Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['New', 'Contacted', 'Quoted', 'Won', 'Lost'],
                    datasets: [{
                        data: [
                            leads.filter(l => l.status === 'new').length,
                            leads.filter(l => l.status === 'contacted').length,
                            leads.filter(l => l.status === 'quoted').length,
                            leads.filter(l => l.status === 'won').length,
                            leads.filter(l => l.status === 'lost').length
                        ],
                        backgroundColor: [
                            '#1976d2',
                            '#f57c00',
                            '#7b1fa2',
                            '#388e3c',
                            '#d32f2f'
                        ]
                    }]
                }
            });

            // Budget Chart
            const budgetCtx = document.getElementById('budgetChart').getContext('2d');
            const budgets = {
                'under-5k': 0,
                '5k-10k': 0,
                '10k-20k': 0,
                '20k-plus': 0
            };
            leads.forEach(lead => {
                if (budgets.hasOwnProperty(lead.projectBudget)) {
                    budgets[lead.projectBudget]++;
                }
            });

            new Chart(budgetCtx, {
                type: 'pie',
                data: {
                    labels: ['Under ¬£5k', '¬£5k-¬£10k', '¬£10k-¬£20k', '¬£20k+'],
                    datasets: [{
                        data: Object.values(budgets),
                        backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#f44336']
                    }]
                }
            });

            // Funnel Chart
            const funnelCtx = document.getElementById('funnelChart').getContext('2d');
            new Chart(funnelCtx, {
                type: 'bar',
                data: {
                    labels: ['Total Leads', 'Contacted', 'Quoted', 'Won'],
                    datasets: [{
                        label: 'Conversion Funnel',
                        data: [
                            leads.length,
                            leads.filter(l => ['contacted', 'quoted', 'won'].includes(l.status)).length,
                            leads.filter(l => ['quoted', 'won'].includes(l.status)).length,
                            leads.filter(l => l.status === 'won').length
                        ],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true
                }
            });

            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            const revenueByMonth = getRevenueByMonth(leads);
            new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(revenueByMonth),
                    datasets: [{
                        label: 'Revenue (¬£)',
                        data: Object.values(revenueByMonth),
                        backgroundColor: '#4caf50'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        function getLast30Days() {
            const days = [];
            for (let i = 29; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                days.push(d.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' }));
            }
            return days;
        }

        function getLeadsByDay(leads) {
            const counts = new Array(30).fill(0);
            leads.forEach(lead => {
                const leadDate = new Date(lead.createdAt);
                const today = new Date();
                const diffDays = Math.floor((today - leadDate) / (1000 * 60 * 60 * 24));
                if (diffDays < 30) {
                    counts[29 - diffDays]++;
                }
            });
            return counts;
        }

        function getRevenueByMonth(leads) {
            const revenue = {};
            leads.filter(l => l.status === 'won' && l.projectValue).forEach(lead => {
                const month = new Date(lead.wonDate || lead.createdAt).toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
                revenue[month] = (revenue[month] || 0) + lead.projectValue;
            });
            return revenue;
        }

        loadAnalytics();
    </script>
</body>
</html>